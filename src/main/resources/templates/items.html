<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <title>Show items</title>
    </head>
    <body>
        <div class="container">
        <h1>Все продукты</h1>
        
        <div id="data-container">
            <div th:each="item : ${initialData}" class="data-item">
                <h3 th:text="${item.name}">Заголовок</h3>
                <p th:text="${item.id}">Id</p>
                <p th:text="${item.calories}">Калорийность</p>
            </div>
        </div>
        
        <div style="text-align: center;">
            <button id="load-more-btn" class="load-more-btn" 
                    th:attr="data-page=${currentPage}, data-total-pages=${totalPages}">
                Загрузить еще
            </button>
        </div>

        <div id="loading-indicator" class="loading" style="display: none;">
            Загрузка...
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let isLoading = false;
            const loadMoreBtn = $('#load-more-btn');
            const dataContainer = $('#data-container');
            const loadingIndicator = $('#loading-indicator');
            
            loadMoreBtn.click(function() {
                if (isLoading) return;
                
                const nextPage = parseInt(loadMoreBtn.data('page')) + 1;
                const totalPages = parseInt(loadMoreBtn.data('total-pages'));
                
                isLoading = true;
                loadMoreBtn.prop('disabled', true);
                loadingIndicator.show();
                
                $.ajax({
                    url: '/item/all',
                    type: 'GET',
                    data: {
                        pageNumber: nextPage,
                    },
                    success: function(response) {
                        response.forEach(element => {
                            dataContainer.append(
                                `<div class="data-item">
                                    <h3>${element["name"]}</h3>
                                    <p>Id: ${element["id"]}</p>
                                    <p>Калорийность: ${element["calories"]}</p>
                                </div>`
                            );
                        });
                        
                        loadMoreBtn.data('page', nextPage);
                        if (response.length != 0) {
                            loadMoreBtn.prop('disabled', false);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Ошибка загрузки:', error);
                        alert('Произошла ошибка при загрузке данных');
                        loadMoreBtn.prop('disabled', false);
                    },
                    complete: function() {
                        isLoading = false;
                        loadingIndicator.hide();
                    }
                });
            });
        });
    </script>
    </body>
</html>